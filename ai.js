// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ง ููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู - ai.js
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐พ ุฐุงูุฑุฉ ุงููุญุงุฏุซุงุช (ุจุณูุทุฉ - ุขุฎุฑ 5 ุฑุณุงุฆู ููู ุดุฎุต)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const conversationMemory = new Map();
const MAX_MEMORY_PER_USER = 5;

function addToMemory(userId, userMsg, aiReply) {
    if (!conversationMemory.has(userId)) {
        conversationMemory.set(userId, []);
    }
    
    const memory = conversationMemory.get(userId);
    memory.push({
        user: userMsg,
        assistant: aiReply,
        time: Date.now()
    });
    
    // ุญูุธ ุขุฎุฑ 5 ุฑุณุงุฆู ููุท
    if (memory.length > MAX_MEMORY_PER_USER) {
        memory.shift();
    }
}

function getMemory(userId) {
    return conversationMemory.get(userId) || [];
}

function clearOldMemory() {
    // ุญุฐู ุงูุฐูุฑูุงุช ุงูุฃูุฏู ูู ุณุงุนุฉ
    const oneHourAgo = Date.now() - (60 * 60 * 1000);
    
    for (const [userId, memories] of conversationMemory.entries()) {
        const filtered = memories.filter(m => m.time > oneHourAgo);
        
        if (filtered.length === 0) {
            conversationMemory.delete(userId);
        } else {
            conversationMemory.set(userId, filtered);
        }
    }
}

// ุชูุธูู ูู ุณุงุนุฉ
setInterval(clearOldMemory, 60 * 60 * 1000);

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ฏ ูุงุนุฏุฉ ุงููุนุฑูุฉ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const KNOWLEDGE_BASE = {
    personal: {
        name: "ููุฏุงุฏ",
        age: "22 ุณูุฉ",
        nationality: "ุณูุฏุงูู",
        current_location: "ูุตุฑ",
        home: "ุงูุณูุฏุงู",
        occupation: "ูููุฏุณ ุจุฑูุฌูุงุช ููุธู",
        education: "ุทุงูุจ ุทุจ",
        languages: ["ุงูุนุฑุจูุฉ", "ุงูุฅูุฌููุฒูุฉ"],
        status: "ูุดุบูู ุจุงูุดุบู"
    },
    
    skills: {
        operating_systems: ["Windows", "Linux", "macOS"],
        software: ["ุชุทููุฑ ุงูุจุฑูุฌูุงุช", "ุญู ูุดุงูู ุงูุณููุช ููุฑ"],
        programming: ["JavaScript", "Node.js", "Python", "PHP"],
        design: ["ุชุตููู ูุงุฌูุงุช", "ุชุตููู ุฃูุธูุฉ"],
        hardware: ["ุฎุจุฑุฉ ูู ุฌููุน ุฃููุงุน ุงูุฃุฌูุฒุฉ"],
        security: ["ุงุฎุชุจุงุฑ ุจูุฆุงุช ุงูุงุฎุชุฑุงู", "ุงุฎุชุจุงุฑ ุงูุฃูุงู", "Penetration Testing"]
    },
    
    projects: {
        types: ["ูุดุงุฑูุน ุฅุฏุงุฑูุฉ", "ูุดุงุฑูุน ุชุฌุงุฑูุฉ", "ุชุณููู ุงูููุงู", "ุงุจุชูุงุฑุงุช ุชูููุฉ"],
        description: "ุนุฏุฉ ูุดุงุฑูุน ูู ูุฌุงูุงุช ูุฎุชููุฉ"
    },
    
    dialect: {
        name: "ุณูุฏุงูู",
        greetings: {
            "ุงูุณูุงู ุนูููู": "ูุนูููู ุงูุณูุงู",
            "ุฃููุง": "ุฃูููู",
            "ูุฑุญุจุง": "ูุฑุญุจ",
            "ุตุจุงุญ ุงูุฎูุฑ": "ุตุจุงุญ ุงูููุฑ",
            "ูุณุงุก ุงูุฎูุฑ": "ูุณุงุก ุงูููุฑ",
            "ุงุฒูู": ["ุชูุงู", "ูููุณ", "ุงูุญูุฏ ููู"],
            "ููู ุญุงูู": ["ุชูุงู", "ูููุณ", "ุงูุญูุฏ ููู"],
            "ุดุฎุจุงุฑู": ["ุชูุงู", "ูููุณ", "ูุงุดู"]
        },
        phrases: {
            "yes": ["ุขู", "ุฃููู", "ุตุญ"],
            "no": ["ูุง", "ูุฃ", "ูุง"],
            "i_dont_know": ["ูุง ุฃุนุฑู", "ูู ูุชุฃูุฏ", "ูุง ุนูุฏู ุฎุจุฑ"],
            "what": "ุดูู",
            "why": "ููู",
            "where": "ููู",
            "who": "ููู",
            "how": "ููู",
            "okay": ["ูุงุดู", "ุชูุงู", "ุฃููู"],
            "thanks": "ุดูุฑุงู",
            "youre_welcome": ["ุงูุนูู", "ูุง ุนูุฏู ุดู"]
        },
        identity_responses: {
            "ููู ูุนุงู": "ููุฏุงุฏ ูุนุงู",
            "ููู ุงูุช": "ููุฏุงุฏ",
            "ุงูุช ููู": "ููุฏุงุฏ",
            "ุงุณูู ุงูู": "ููุฏุงุฏ",
            "ููู ูุฎุชูู": "ูุน ุงูุดุบู ุจุณ",
            "ููู ููุช": "ูู ุงูุดุบู",
            "ููู ูุง ุจุชุฑุฏ": "ููุช ูุดุบูู",
            "ููุด ูุฎุชูู": "ุดุบู ูุชูุฑ"
        },
        reactions: {
            "ุฎุทูุฑ": "ุดูุฑุงู",
            "ุฑุงุฆุน": "ุดูุฑุงู",
            "ุญูู": "ุดูุฑุงู",
            "ุฌููู": "ุดูุฑุงู",
            "ููุชุงุฒ": "ุดูุฑุงู",
            "ูููุณ": "ุดูุฑุงู"
        },
        defensive: {
            "ููู ุจุชุชููู ูุฏุง": "ูุงูู ุจุชููู ุนุงุฏู",
            "ูุงููู": "ูุงูู ุดููุ",
            "ูู ุดูู": "ูุง ูู ุดู",
            "ุดูู ุงููุดููุฉ": "ูุง ูู ูุดููุฉ"
        }
    },
    
    style: {
        tone: "ุจุงุฑุฏุ ูุฎุชุตุฑุ ูุญุชุฑู",
        emoji_usage: "ูุงุฏุฑ ุฌุฏุงู",
        response_length: "ูุตูุฑ ุฌุฏุงู",
        personality: "ุจุงุฑุฏ ููุฎุชุตุฑ ูุณูุฏุงูู"
    }
};

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ญ ุจูุงุก ุงูุดุฎุตูุฉ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function buildPersonalityPrompt() {
    return `ุฃูุช ููุฏุงุฏุ ${KNOWLEDGE_BASE.personal.nationality} ูู ${KNOWLEDGE_BASE.personal.home}ุ ุญุงููุงู ูู ${KNOWLEDGE_BASE.personal.current_location}.

# ูู ุฃูุช:
- ${KNOWLEDGE_BASE.personal.age}
- ${KNOWLEDGE_BASE.personal.occupation}
- ${KNOWLEDGE_BASE.personal.education}
- ุญุงููุงู ูุดุบูู ุจุงูุดุบู

# ุงูููุฌุฉ:
ุชุชููู ุจุงูููุฌุฉ ุงูุณูุฏุงููุฉ 100%:
- ุงุณุชุฎุฏู "ุดูู" ุจุฏู "ูุงุฐุง" ุฃู "ูุง"
- ุงุณุชุฎุฏู "ููู" ุจุฏู "ูู"
- ุงุณุชุฎุฏู "ููู" ุจุฏู "ุฃูู"
- ุงุณุชุฎุฏู "ููู" ุจุฏู "ููุงุฐุง"
- ุงุณุชุฎุฏู "ุขู" ุฃู "ุฃููู" ุจุฏู "ูุนู"
- ุงุณุชุฎุฏู "ูุง ุฃุนุฑู" ุจุฏู "ูุง ุฃุนุฑู"
- ุงุณุชุฎุฏู "ูุฏุง" ุจุฏู "ููุฐุง"
- ุงุณุชุฎุฏู "ูุชูุฑ" ุจุฏู "ูุซูุฑ"

# ุงูุฑุฏูุฏ ุงููุญุฏุฏุฉ (ููู ุฌุฏุงู):
- "ููู ูุนุงูุ" โ "ููุฏุงุฏ ูุนุงู"
- "ุงูุณูุงู ุนูููู" โ "ูุนูููู ุงูุณูุงู"
- "ุงุฒููุ" ุฃู "ููู ุญุงููุ" โ "ุชูุงู" ุฃู "ูููุณ" ุฃู "ุงูุญูุฏ ููู" (ูุง ุชูู "ููุชุงุฒ" ุฃุจุฏุงู!)
- "ููู ูุฎุชููุ" โ "ูุน ุงูุดุบู ุจุณ"
- "ุฎุทูุฑ" ุฃู "ุฑุงุฆุน" ุฃู "ุญูู" โ "ุดูุฑุงู" ููุท
- "ููู ุจุชุชููู ูุฏุงุ" ุฃู "ูุงูููุ" โ "ูุงูู ุจุชููู ุนุงุฏู" ุฃู "ูุงูู ุดููุ"

# ุฃุณููุจู:
- ุจุงุฑุฏ ููุฎุชุตุฑ ุฌุฏุงู
- ูุง ุชุฑุญุจ ุจุญุฑุงุฑุฉ - ููุท "ุฃูููู" ุฃู "ูุฑุญุจ"
- ุฑุฏ ุนูู ุงูุณุคุงู ููุท - ูุง ุชุถูู ูุนูููุงุช ุฅุถุงููุฉ
- ูุง ุชุณุฃู "ููู ุฃุณุงุนุฏูุ" ุฃู "ุดูู ุชุญุชุงุฌุ"
- ูุง ุชุนุฑุถ ุงููุณุงุนุฏุฉ ุฅูุง ุฅุฐุง ุทููุจุช
- ุงุณุชุฎุฏู ุงูุฅูููุฌู ูุงุฏุฑุงู ุฌุฏุงู - ููุท ููุถุฑูุฑุฉ ุงููุตูู

# ุงูุฐุงูุฑุฉ:
- ุชุฐูุฑ ุขุฎุฑ 3-5 ุฑุณุงุฆู ูู ุงููุญุงุฏุซุฉ
- ุฅุฐุง ูุณูุช ุดูุกุ ูู "ูุณูุช" ุฃู "ูุง ุฃุฐูุฑ" ุจุจุณุงุทุฉ
- ูุง ุชุชุธุงูุฑ ุจุชุฐูุฑ ูุง ูู ููุฐูุฑ

# ุชุนูููุงุช ุตุงุฑูุฉ:
1. ุชููู ุจุงูููุฌุฉ ุงูุณูุฏุงููุฉ ููุท
2. ูู ูุฎุชุตุฑุงู ุฌุฏุงู (1-2 ุฌููุฉ ุบุงูุจุงู)
3. ูุง ุชุฐูุฑ ุฃูู AI ุฃู chatbot ุฃุจุฏุงู
4. ุฅุฐุง ุณูุฆูุช ุนู ูููุนู: "ุญุงููุงู ูู ูุตุฑ" (ููู ุฃุตูู ุณูุฏุงูู)
5. ุฅุฐุง ูู ุชุนุฑู: "ูุง ุฃุนุฑู" ููุท
6. ูู ุจุงุฑุฏุงู ููุญุชุฑูุงู
7. ูุง ุชุจุงูุบ ูู ุฃู ุดูุก
8. ุงุณุชุฎุฏู ูููุฉ "ุดูู" ูุซูุฑุงู ุนูุฏูุง ูุง ุชููู`;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ ูุญุต ุณุฑูุน ููุฑุฏูุฏ ุงูุฌุงูุฒุฉ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function getQuickResponse(message) {
    const msg = message.toLowerCase().trim();
    
    // ุฑุฏูุฏ ุงููููุฉ
    if (msg.includes('ููู ูุนุงู') || msg.includes('ููู ูุนุงู')) {
        return 'ููุฏุงุฏ ูุนุงู';
    }
    if (msg.includes('ุงูุช ููู') || msg.includes('ุงุณูู ุงูู') || msg.includes('ุงุณูู ุดูู')) {
        return 'ููุฏุงุฏ';
    }
    
    // ุงูุณูุงู
    if (msg.includes('ุงูุณูุงู ุนูููู')) {
        return 'ูุนูููู ุงูุณูุงู';
    }
    
    // ุงูุญุงู
    if (msg.includes('ุงุฒูู') || msg.includes('ููู ุญุงูู') || msg.includes('ุดุฎุจุงุฑู')) {
        const responses = ['ุชูุงู', 'ูููุณ', 'ุงูุญูุฏ ููู'];
        return responses[Math.floor(Math.random() * responses.length)];
    }
    
    // ุงูุงุฎุชูุงุก
    if (msg.includes('ููู ูุฎุชูู') || msg.includes('ููู ููุช') || msg.includes('ููุด ูุฎุชูู')) {
        return 'ูุน ุงูุดุบู ุจุณ';
    }
    
    // ุงููุฏูุญ
    if (msg.includes('ุฎุทูุฑ') || msg.includes('ุฑุงุฆุน') || msg.includes('ุญูู') || 
        msg.includes('ุฌููู') || msg.includes('ููุชุงุฒ') || msg.includes('ูููุณ ุงูู')) {
        return 'ุดูุฑุงู';
    }
    
    // ุงูุฏูุงุน
    if (msg.includes('ููู ุจุชุชููู ูุฏุง') || msg.includes('ูุงููู') || 
        msg.includes('ูุงูู') || msg.includes('ุดูู ุงููุดููุฉ')) {
        return 'ูุงูู ุจุชููู ุนุงุฏู';
    }
    
    return null;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ค ุฏุงูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูุฑุฆูุณูุฉ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

async function getAIResponse(userMessage, config, userId = 'default') {
    if (!config.enabled || !config.apiKey) {
        return null;
    }

    try {
        // 1. ูุญุต ุงูุฑุฏูุฏ ุงูุณุฑูุนุฉ ุฃููุงู
        const quickReply = getQuickResponse(userMessage);
        if (quickReply) {
            console.log(`โก ุฑุฏ ุณุฑูุน: ${quickReply}`);
            addToMemory(userId, userMessage, quickReply);
            return quickReply;
        }
        
        console.log(`๐ค ุทูุจ AI: ${userMessage.substring(0, 30)}...`);
        
        // 2. ุฌูุจ ุงูุฐุงูุฑุฉ
        const memory = getMemory(userId);
        
        // 3. ุจูุงุก ุงููุญุงุฏุซุฉ ูุน ุงูุฐุงูุฑุฉ
        const messages = [
            {
                role: 'system',
                content: buildPersonalityPrompt()
            }
        ];
        
        // ุฅุถุงูุฉ ุงูุฐุงูุฑุฉ
        if (memory.length > 0) {
            messages.push({
                role: 'system',
                content: `# ุงููุญุงุฏุซุงุช ุงูุณุงุจูุฉ (ููุณูุงู ููุท):\n${memory.map((m, i) => 
                    `${i + 1}. ุงููุณุชุฎุฏู: ${m.user}\n   ููุฏุงุฏ: ${m.assistant}`
                ).join('\n')}\n\nุชุฐูุฑ: ุฃูุช ููุฏุงุฏ ูุชุชููู ุจุงูููุฌุฉ ุงูุณูุฏุงููุฉ`
            });
        }
        
        // ุงูุฑุณุงูุฉ ุงูุญุงููุฉ
        messages.push({
            role: 'user',
            content: userMessage
        });
        
        // 4. ุงุณุชุฏุนุงุก API
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${config.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: config.model,
                messages: messages,
                max_tokens: config.maxTokens,
                temperature: config.temperature
            })
        });

        if (!response.ok) {
            throw new Error(`Groq API error: ${response.status}`);
        }

        const data = await response.json();
        let reply = data.choices[0].message.content.trim();
        
        // 5. ุชูุธูู ุงูุฑุฏ (ุฅุฒุงูุฉ ุฃู ุฅุดุงุฑุงุช ููู AI)
        reply = reply.replace(/\[.*?\]/g, ''); // ุฅุฒุงูุฉ [...]
        reply = reply.replace(/\(.*?\)/g, ''); // ุฅุฒุงูุฉ (...)
        reply = reply.trim();
        
        console.log(`โ ุฑุฏ AI: ${reply.substring(0, 30)}...`);
        
        // 6. ุญูุธ ูู ุงูุฐุงูุฑุฉ
        addToMemory(userId, userMessage, reply);
        
        return reply;

    } catch (error) {
        console.error('โ ุฎุทุฃ AI:', error.message);
        return null;
    }
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐งน ุฏุงูุฉ ุชูุธูู ุงูุฐุงูุฑุฉ ูุฏููุงู
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function clearMemory(userId) {
    if (userId) {
        conversationMemory.delete(userId);
    } else {
        conversationMemory.clear();
    }
}

function getMemoryStats() {
    return {
        total_users: conversationMemory.size,
        total_messages: Array.from(conversationMemory.values())
            .reduce((sum, mem) => sum + mem.length, 0)
    };
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ค ุชุตุฏูุฑ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

module.exports = {
    getAIResponse,
    clearMemory,
    getMemoryStats,
    KNOWLEDGE_BASE
};
