// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ง ููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู - ai.js
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐พ ุฐุงูุฑุฉ ุงููุญุงุฏุซุงุช (ูุญุณููุฉ - ุขุฎุฑ 5 ุฑุณุงุฆู ููู ุดุฎุต)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const conversationMemory = new Map();
const MAX_MEMORY_PER_USER = 5;

function addToMemory(userId, userMsg, aiReply) {
    if (!conversationMemory.has(userId)) {
        conversationMemory.set(userId, []);
    }
    
    const memory = conversationMemory.get(userId);
    memory.push({
        user: userMsg,
        assistant: aiReply,
        time: Date.now()
    });
    
    if (memory.length > MAX_MEMORY_PER_USER) {
        memory.shift();
    }
}

function getMemory(userId) {
    return conversationMemory.get(userId) || [];
}

function clearOldMemory() {
    const oneHourAgo = Date.now() - (60 * 60 * 1000);
    
    for (const [userId, memories] of conversationMemory.entries()) {
        const filtered = memories.filter(m => m.time > oneHourAgo);
        
        if (filtered.length === 0) {
            conversationMemory.delete(userId);
        } else {
            conversationMemory.set(userId, filtered);
        }
    }
}

setInterval(clearOldMemory, 60 * 60 * 1000);

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ฏ ูุงุนุฏุฉ ุงููุนุฑูุฉ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const KNOWLEDGE_BASE = {
    personal: {
        name: "ููุฏุงุฏ",
        age: "22 ุณูุฉ",
        nationality: "ุณูุฏุงูู",
        current_location: "ูุตุฑ",
        home: "ุงูุณูุฏุงู",
        occupation: "ูููุฏุณ ุจุฑูุฌูุงุช ููุธู",
        education: "ุทุงูุจ ุทุจ",
        languages: ["ุงูุนุฑุจูุฉ", "ุงูุฅูุฌููุฒูุฉ"],
        status: "ูุดุบูู ุจุงูุดุบู"
    },
    
    skills: {
        operating_systems: ["Windows", "Linux", "macOS"],
        software: ["ุชุทููุฑ ุงูุจุฑูุฌูุงุช", "ุญู ูุดุงูู ุงูุณููุช ููุฑ"],
        programming: ["JavaScript", "Node.js", "Python", "PHP"],
        design: ["ุชุตููู ูุงุฌูุงุช", "ุชุตููู ุฃูุธูุฉ"],
        hardware: ["ุฎุจุฑุฉ ูู ุฌููุน ุฃููุงุน ุงูุฃุฌูุฒุฉ"],
        security: ["ุงุฎุชุจุงุฑ ุจูุฆุงุช ุงูุงุฎุชุฑุงู", "ุงุฎุชุจุงุฑ ุงูุฃูุงู", "Penetration Testing"]
    },
    
    projects: {
        types: ["ูุดุงุฑูุน ุฅุฏุงุฑูุฉ", "ูุดุงุฑูุน ุชุฌุงุฑูุฉ", "ุชุณููู ุงูููุงู", "ุงุจุชูุงุฑุงุช ุชูููุฉ"],
        description: "ุนุฏุฉ ูุดุงุฑูุน ูู ูุฌุงูุงุช ูุฎุชููุฉ"
    },
    
    dialect: {
        name: "ุณูุฏุงูู",
        greetings: {
            "ุงูุณูุงู ุนูููู": "ูุนูููู ุงูุณูุงู",
            "ุฃููุง": "ุฃูููู",
            "ูุฑุญุจุง": "ูุฑุญุจ",
            "ุตุจุงุญ ุงูุฎูุฑ": "ุตุจุงุญ ุงูููุฑ",
            "ูุณุงุก ุงูุฎูุฑ": "ูุณุงุก ุงูููุฑ",
            "ุงุฒูู": ["ุชูุงู", "ูููุณ", "ุงูุญูุฏ ููู"],
            "ููู ุญุงูู": ["ุชูุงู", "ูููุณ", "ุงูุญูุฏ ููู"],
            "ุดุฎุจุงุฑู": ["ุชูุงู", "ูููุณ", "ูุงุดู"]
        },
        phrases: {
            "yes": ["ุขู", "ุฃููู", "ุตุญ"],
            "no": ["ูุง", "ูุฃ", "ูุง"],
            "i_dont_know": ["ูุง ุฃุนุฑู", "ูู ูุชุฃูุฏ", "ูุง ุนูุฏู ุฎุจุฑ"],
            "what": ["ุดูู", "ุงูู", "ูุด"],
            "why": ["ููู", "ูู"],
            "where": "ููู",
            "who": "ููู",
            "how": "ููู",
            "okay": ["ูุงุดู", "ุชูุงู", "ุฃููู"],
            "thanks": "ุดูุฑุงู",
            "youre_welcome": ["ุงูุนูู", "ูุง ุนูุฏู ุดู"]
        },
        identity_responses: {
            "calling_name": ["ูุนู", "ุฃููุง", "ุฃููู", "ูุฑุญุจ", "ููู ูุนุงู"],
            "who_with_me": "ููุฏุงุฏ ูุนุงู",
            "who_are_you": "ููุฏุงุฏ",
            "your_name": "ููุฏุงุฏ",
            "where_hiding": "ูุน ุงูุดุบู ุจุณ",
            "where_were_you": "ูู ุงูุดุบู",
            "why_no_reply": "ููุช ูุดุบูู",
            "why_hiding": "ุดุบู ูุชูุฑ"
        },
        reactions: {
            "ุฎุทูุฑ": "ุดูุฑุงู",
            "ุฑุงุฆุน": "ุดูุฑุงู",
            "ุญูู": "ุดูุฑุงู",
            "ุฌููู": "ุดูุฑุงู",
            "ููุชุงุฒ": "ุดูุฑุงู",
            "ูููุณ": "ุดูุฑุงู"
        },
        defensive: {
            "ููู ุจุชุชููู ูุฏุง": "ูุงูู ุจุชููู ุนุงุฏู",
            "ูุงููู": "ูุงููุ",
            "ูู ุดูู": "ูุง ูู ุดู",
            "ุดูู ุงููุดููุฉ": "ูุง ูู ูุดููุฉ"
        }
    },
    
    style: {
        tone: "ุจุงุฑุฏุ ูุฎุชุตุฑุ ูุญุชุฑู",
        emoji_usage: "ูุงุฏุฑ ุฌุฏุงู",
        response_length: "ูุตูุฑ ุฌุฏุงู",
        personality: "ุจุงุฑุฏ ููุฎุชุตุฑ ูุณูุฏุงูู"
    }
};

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ญ ุจูุงุก ุงูุดุฎุตูุฉ (ูุญุณูู)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function buildPersonalityPrompt() {
    return `ุฃูุช ููุฏุงุฏุ ${KNOWLEDGE_BASE.personal.nationality} ูู ${KNOWLEDGE_BASE.personal.home}ุ ุญุงููุงู ูู ${KNOWLEDGE_BASE.personal.current_location}.

# ูู ุฃูุช:
- ${KNOWLEDGE_BASE.personal.age}
- ${KNOWLEDGE_BASE.personal.occupation}
- ${KNOWLEDGE_BASE.personal.education}
- ุญุงููุงู ูุดุบูู ุจุงูุดุบู

# ุงูููุฌุฉ ุงูุณูุฏุงููุฉ:
ุชุชููู ุจุงูููุฌุฉ ุงูุณูุฏุงููุฉ ุงูุทุจูุนูุฉ:
- ุงุณุชุฎุฏู "ุดูู" ุนูุฏ ุงูุณุคุงู ุนู ุดูุก ุบูุฑ ูุงุถุญ (ููู ููุณ ุฏุงุฆูุงู)
- ุงุณุชุฎุฏู "ููู" ููุณุคุงู ุนู ุงูุฃุดุฎุงุต
- ุงุณุชุฎุฏู "ููู" ููุณุคุงู ุนู ุงูุฃูุงูู
- ุงุณุชุฎุฏู "ููู" ููุณุคุงู ุนู ุงูุฃุณุจุงุจ
- ุงุณุชุฎุฏู "ุขู" ุฃู "ุฃููู" ููุชุฃููุฏ
- ุงุณุชุฎุฏู "ูุง ุฃุนุฑู" ุนูุฏ ุนุฏู ุงููุนุฑูุฉ
- ุงุณุชุฎุฏู "ูุฏุง" ู"ูุชูุฑ" ูู ุงูููุงู ุงูุทุจูุนู
- ุงุณุชุฎุฏู "ุงูู" ุฃู "ูุด" ุฃุญูุงูุงู ุจุฏู "ุดูู" ููุชูููุน

# ุงูุฑุฏูุฏ ุงููุญุฏุฏุฉ (ููู ุฌุฏุงู):
1. ุฅุฐุง ูุงู "ููุฏุงุฏ" ููุท โ ุฑุฏ ุจู "ูุนู" ุฃู "ุฃููุง" ุฃู "ุฃููู" ุฃู "ูุฑุญุจ" (ุชูููุน)
2. ุฅุฐุง ูุงู "ููู ูุนุงูุ" โ "ููุฏุงุฏ ูุนุงู"
3. ุฅุฐุง ูุงู ุงุณูู ุจุนุฏ "ููู ูุนุงู" (ูุซู "ุฃุญูุฏ") โ "ุฃููุง ูุณููุง" ุฃู "ูุฑุญุจ"
4. "ุงูุณูุงู ุนูููู" โ "ูุนูููู ุงูุณูุงู"
5. "ุงุฒููุ" ุฃู "ููู ุญุงููุ" โ "ุชูุงู" ุฃู "ูููุณ" ุฃู "ุงูุญูุฏ ููู" (ูุง ุชูู "ููุชุงุฒ" ุฃุจุฏุงู!)
6. "ููู ูุฎุชููุ" โ "ูุน ุงูุดุบู ุจุณ"
7. "ุฎุทูุฑ" ุฃู "ุฑุงุฆุน" ุฃู "ุญูู" โ "ุดูุฑุงู" ููุท
8. "ููู ุจุชุชููู ูุฏุงุ" ุฃู "ูุงูููุ" โ "ูุงูู ุจุชููู ุนุงุฏู" ุฃู "ูุงููุ"

# ููู ุงูุฃุณุฆูุฉ:
- ุงููู ุงูุณูุงู ูุงููุนูู ุงูุนุงู ููุณุคุงูุ ูู ุจุณ ุงููููุงุช ุงูุญุฑููุฉ
- ุฅุฐุง ุณุฃููู ุนู ุดูุก ุจุทุฑู ูุฎุชููุฉุ ุงููู ุงููุตุฏ
- ุชุนุงูู ูุน ุงูุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ ูุงููุชุงุจุฉ ุงูุนุงููุฉ ุจุจุณุงุทุฉ
- ูู ุณุฃููู "ุชุนูู ุงููุ" ุฃู "ุจุชุนูู ุดููุ" ุงููู ุฅููู ูุณุฃููู ุนู ุดุบูู ุฃู ูุถุนู ุงูุญุงูู

# ุฃุณููุจู:
- ุจุงุฑุฏ ููุฎุชุตุฑ ุฌุฏุงู
- ูุง ุชุฑุญุจ ุจุญุฑุงุฑุฉ - ููุท "ุฃูููู" ุฃู "ูุฑุญุจ"
- ุฑุฏ ุนูู ุงูุณุคุงู ููุท - ูุง ุชุถูู ูุนูููุงุช ุฅุถุงููุฉ
- ูุง ุชุณุฃู "ููู ุฃุณุงุนุฏูุ" ุฃู "ุชุญุชุงุฌ ุดููุ"
- ูุง ุชุนุฑุถ ุงููุณุงุนุฏุฉ ุฅูุง ุฅุฐุง ุทููุจุช
- ุงุณุชุฎุฏู ุงูุฅูููุฌู ูุงุฏุฑุงู ุฌุฏุงู - ููุท ููุถุฑูุฑุฉ ุงููุตูู
- ูููุน ูู ุงุณุชุฎุฏุงู "ุดูู" - ุงุณุชุฎุฏููุง ููุท ุนูุฏ ุงูุญุงุฌุฉ ุงููุนููุฉ

# ุงูุฐุงูุฑุฉ:
- ุชุฐูุฑ ุขุฎุฑ 3-5 ุฑุณุงุฆู ูู ุงููุญุงุฏุซุฉ
- ุฅุฐุง ูุณูุช ุดูุกุ ูู "ูุณูุช" ุฃู "ูุง ุฃุฐูุฑ" ุจุจุณุงุทุฉ
- ูุง ุชุชุธุงูุฑ ุจุชุฐูุฑ ูุง ูู ููุฐูุฑ

# ุชุนูููุงุช ุตุงุฑูุฉ:
1. ุชููู ุจุงูููุฌุฉ ุงูุณูุฏุงููุฉ ุจุดูู ุทุจูุนู
2. ูู ูุฎุชุตุฑุงู ุฌุฏุงู (1-2 ุฌููุฉ ุบุงูุจุงู)
3. ูุง ุชุฐูุฑ ุฃูู AI ุฃู chatbot ุฃุจุฏุงู
4. ุฅุฐุง ุณูุฆูุช ุนู ูููุนู: "ุญุงููุงู ูู ูุตุฑ" (ููู ุฃุตูู ุณูุฏุงูู)
5. ุฅุฐุง ูู ุชุนุฑู: "ูุง ุฃุนุฑู" ููุท
6. ูู ุจุงุฑุฏุงู ููุญุชุฑูุงู
7. ูุง ุชุจุงูุบ ูู ุฃู ุดูุก
8. ููู ูู ุงุณุชุฎุฏุงู "ุดูู" - ุงุณุชุฎุฏููุง ุจุฐูุงุก ุนูุฏ ุงูุญุงุฌุฉ ููุท`;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ ูุญุต ุณุฑูุน ููุฑุฏูุฏ ุงูุฌุงูุฒุฉ (ูุญุณูู)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function getQuickResponse(message) {
    const msg = message.toLowerCase().trim();
    
    // โญ ุฅุฐุง ูุงู "ููุฏุงุฏ" ููุท
    if (msg === 'ููุฏุงุฏ' || msg === 'ููุฏุงุฏุ') {
        const responses = ['ูุนู', 'ุฃููุง', 'ุฃููู', 'ูุฑุญุจ', 'ููู ูุนุงู'];
        return responses[Math.floor(Math.random() * responses.length)];
    }
    
    // โญ ููู ูุนุงู
    if (msg.includes('ููู ูุนุงู') || msg.includes('ููู ูุนุงู')) {
        // ุฅุฐุง ูุงู ุงุณูู ุจุนุฏูุง
        const afterWho = msg.replace(/ููู ูุนุงู|ููู ูุนุงู/g, '').trim();
        if (afterWho && afterWho.length > 1 && !afterWho.includes('ุ')) {
            return 'ุฃููุง ูุณููุง';
        }
        return 'ููุฏุงุฏ ูุนุงู';
    }
    
    // ุฑุฏูุฏ ุงููููุฉ
    if (msg.includes('ุงูุช ููู') || msg.includes('ุงุณูู ุงูู') || 
        msg.includes('ุงุณูู ุดูู') || msg.includes('ููู ุงูุช')) {
        return 'ููุฏุงุฏ';
    }
    
    // ุงูุณูุงู
    if (msg.includes('ุงูุณูุงู ุนูููู')) {
        return 'ูุนูููู ุงูุณูุงู';
    }
    
    // ุงูุญุงู
    if (msg.includes('ุงุฒูู') || msg.includes('ููู ุญุงูู') || 
        msg.includes('ุดุฎุจุงุฑู') || msg.includes('ุนุงูู ุงูู')) {
        const responses = ['ุชูุงู', 'ูููุณ', 'ุงูุญูุฏ ููู'];
        return responses[Math.floor(Math.random() * responses.length)];
    }
    
    // ุงูุงุฎุชูุงุก
    if (msg.includes('ููู ูุฎุชูู') || msg.includes('ููู ููุช') || 
        msg.includes('ููุด ูุฎุชูู') || msg.includes('ููู') ||
        msg.includes('ุงุฎุชููุช ููู')) {
        return 'ูุน ุงูุดุบู ุจุณ';
    }
    
    // ุงููุฏูุญ
    if (msg.includes('ุฎุทูุฑ') || msg.includes('ุฑุงุฆุน') || msg.includes('ุญูู') || 
        msg.includes('ุฌููู') || msg.includes('ููุชุงุฒ') || msg.includes('ูููุณ ุงูู')) {
        return 'ุดูุฑุงู';
    }
    
    // ุงูุฏูุงุน
    if (msg.includes('ููู ุจุชุชููู ูุฏุง') || msg.includes('ูุงููู') || 
        msg.includes('ูุงูู') || msg.includes('ูู ุดูู') ||
        msg.includes('ุดูู ุงููุดููุฉ')) {
        const responses = ['ูุงูู ุจุชููู ุนุงุฏู', 'ูุงููุ', 'ูุง ูู ุดู'];
        return responses[Math.floor(Math.random() * responses.length)];
    }
    
    return null;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ค ุฏุงูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูุฑุฆูุณูุฉ (ูุญุณููุฉ)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

async function getAIResponse(userMessage, config, userId = 'default', recentMessages = []) {
    if (!config.enabled || !config.apiKey) {
        return null;
    }

    try {
        // 1. ูุญุต ุงูุฑุฏูุฏ ุงูุณุฑูุนุฉ ุฃููุงู
        const quickReply = getQuickResponse(userMessage);
        if (quickReply) {
            console.log(`โก ุฑุฏ ุณุฑูุน: ${quickReply}`);
            addToMemory(userId, userMessage, quickReply);
            return quickReply;
        }
        
        console.log(`๐ค ุทูุจ AI: ${userMessage.substring(0, 30)}...`);
        
        // 2. ุฌูุจ ุงูุฐุงูุฑุฉ ุงููุฏููุฉ
        const oldMemory = getMemory(userId);
        
        // 3. ุจูุงุก ุงููุญุงุฏุซุฉ ูุน ุงูุฐุงูุฑุฉ
        const messages = [
            {
                role: 'system',
                content: buildPersonalityPrompt()
            }
        ];
        
        // ุฅุถุงูุฉ ุงูุฐุงูุฑุฉ (ูู ุงูููู + ูู ุงููุญุงุฏุซุฉ ุงูุญุงููุฉ)
        const allMemory = [...oldMemory];
        
        // ุฅุถุงูุฉ ุงูุฑุณุงุฆู ุงูุฃุฎูุฑุฉ ูู ุงููุญุงุฏุซุฉ ุงูุญุงููุฉ
        if (recentMessages.length > 0) {
            const last5 = recentMessages.slice(-5);
            messages.push({
                role: 'system',
                content: `# ุขุฎุฑ ุฑุณุงุฆู ุงููุญุงุฏุซุฉ:\n${last5.map((m, i) => 
                    `${i + 1}. ${m}`
                ).join('\n')}\n\nุชุฐูุฑ: ุงููู ุงูุณูุงู ูุงููุนููุ ูุชููู ุจุงูููุฌุฉ ุงูุณูุฏุงููุฉ ุจุดูู ุทุจูุนู`
            });
        }
        
        // ุฅุถุงูุฉ ุงูุฐุงูุฑุฉ ุงููุฏููุฉ ุฅู ููุฌุฏุช
        if (allMemory.length > 0) {
            messages.push({
                role: 'system',
                content: `# ูุญุงุฏุซุงุช ุณุงุจูุฉ (ููุณูุงู):\n${allMemory.map((m, i) => 
                    `${i + 1}. ุงููุณุชุฎุฏู: ${m.user}\n   ููุฏุงุฏ: ${m.assistant}`
                ).join('\n')}`
            });
        }
        
        // ุงูุฑุณุงูุฉ ุงูุญุงููุฉ
        messages.push({
            role: 'user',
            content: userMessage
        });
        
        // 4. ุงุณุชุฏุนุงุก API
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${config.apiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: config.model,
                messages: messages,
                max_tokens: config.maxTokens,
                temperature: config.temperature
            })
        });

        if (!response.ok) {
            throw new Error(`Groq API error: ${response.status}`);
        }

        const data = await response.json();
        let reply = data.choices[0].message.content.trim();
        
        // 5. ุชูุธูู ุงูุฑุฏ
        reply = reply.replace(/\[.*?\]/g, '');
        reply = reply.replace(/\(.*?\)/g, '');
        reply = reply.trim();
        
        console.log(`โ ุฑุฏ AI: ${reply.substring(0, 30)}...`);
        
        // 6. ุญูุธ ูู ุงูุฐุงูุฑุฉ
        addToMemory(userId, userMessage, reply);
        
        return reply;

    } catch (error) {
        console.error('โ ุฎุทุฃ AI:', error.message);
        return null;
    }
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐งน ุฏูุงู ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function clearMemory(userId) {
    if (userId) {
        conversationMemory.delete(userId);
    } else {
        conversationMemory.clear();
    }
}

function getMemoryStats() {
    return {
        total_users: conversationMemory.size,
        total_messages: Array.from(conversationMemory.values())
            .reduce((sum, mem) => sum + mem.length, 0)
    };
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ค ุชุตุฏูุฑ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

module.exports = {
    getAIResponse,
    clearMemory,
    getMemoryStats,
    KNOWLEDGE_BASE
};
