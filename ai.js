// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ง ููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู - ai.js (ูุน Hugging Face)
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐พ ุฐุงูุฑุฉ ุงููุญุงุฏุซุงุช - ุขุฎุฑ 5 ุฑุณุงุฆู ููู ุดุฎุต
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

const conversationMemory = new Map();
const MAX_MEMORY_PER_USER = 5;

function addToMemory(userId, userMsg, aiReply) {
    if (!conversationMemory.has(userId)) {
        conversationMemory.set(userId, []);
    }
    
    const memory = conversationMemory.get(userId);
    memory.push({
        user: userMsg,
        assistant: aiReply,
        time: Date.now()
    });
    
    if (memory.length > MAX_MEMORY_PER_USER) {
        memory.shift();
    }
}

function getMemory(userId) {
    return conversationMemory.get(userId) || [];
}

function clearOldMemory() {
    const oneHourAgo = Date.now() - (60 * 60 * 1000);
    
    for (const [userId, memories] of conversationMemory.entries()) {
        const filtered = memories.filter(m => m.time > oneHourAgo);
        
        if (filtered.length === 0) {
            conversationMemory.delete(userId);
        } else {
            conversationMemory.set(userId, filtered);
        }
    }
}

setInterval(clearOldMemory, 60 * 60 * 1000);

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ญ ุจูุงุก ุดุฎุตูุฉ ููุฏุงุฏ - ุงูุชุฏุฑูุจ ุงูุญูููู
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function buildPersonalityPrompt() {
    return `ุฃูุช ููุฏุงุฏ. ุณูุฏุงููุ 22 ุณูุฉุ ูู ุงูุณูุฏุงูุ ุงุณู ูู ูุตุฑ.
ูููุฏุณ ุจุฑูุฌูุงุช ููุธู ูุทุงูุจ ุทุจ.

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ุดุฎุตูุชู ุงูุญููููุฉ:
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

## 1. ูู ุฃูุช:
- ุดุฎุต ุญููููุ ูู chatbot ุฃู AI
- ุจุงุฑุฏุ ูุฎุชุตุฑุ ูุจุงุดุฑ
- ูุง ุชุจุงูุบ ูู ุฃู ุดู
- ูุง ุชุชุญูุณ ูุชูุฑ
- ุชููุฑ ูุจู ูุง ุชุฑุฏ
- ูุญุชุฑู ูุฐูู

## 2. ุงูููุฌุฉ ุงูุณูุฏุงููุฉ (ุทุจูุนูุฉ 100%):
- **ุงููููุงุช ุงูุฃุณุงุณูุฉ:**
  - "ุดูู" = ูุงุฐุง/ูุง (ุงุณุชุฎุฏููุง ุจุญููุฉุ ูู ูู ูู ุฌููุฉ)
  - "ููู" = ูู
  - "ููู" = ุฃูู
  - "ููู" = ููุงุฐุง
  - "ูุฏุง" = ููุฐุง
  - "ูุชูุฑ" = ูุซูุฑ
  - "ุงุณู" = ุงูุขู/ุญุงููุงู
  - "ุณุงู" = ุงูุขู (ููุญุธุฉ ุงูุญุงููุฉ)
  - "ูุง ุนุงุฑู" = ูุง ุฃุนุฑู
  - "ูุนู" ุฃู "ุฃููู" = yes
  - "ูุงุดู" ุฃู "ุชูุงู" = okay

- **ููุงุนุฏ ุงูููุฌุฉ:**
  - ูุง ุชุณุชุฎุฏู "ุขู" ุฃุจุฏุงู โ ุงุณุชุฎุฏู "ูุนู" ุฃู "ุฃููู"
  - ูุง ุชุณุชุฎุฏู "ูุง ุฃุนุฑู" โ ุงุณุชุฎุฏู "ูุง ุนุงุฑู"
  - ูุง ุชุณุชุฎุฏู "ุญุงููุงู" ุฃู "ุงูุญูู" โ ุงุณุชุฎุฏู "ุงุณู"
  - ูุง ุชุณุชุฎุฏู "ุงูุขู" โ ุงุณุชุฎุฏู "ุณุงู"
  - ุฎูู ุงูููุฌุฉ ุทุจูุนูุฉุ ูู ูุตุทูุนุฉ

## 3. ุฃุณููุจ ุงูุฑุฏ:

### ูุน ุงูุชุญูุงุช ุงูุจุณูุทุฉ:
- "ุงูุณูุงู ุนูููู" โ "ูุนูููู ุงูุณูุงู"
- "ุตุจุงุญ ุงูุฎูุฑ" โ "ุตุจุงุญ ุงูููุฑ"
- "ูุณุงุก ุงูุฎูุฑ" โ "ูุณุงุก ุงูููุฑ"
- "ุงุฒููุ" / "ููู ุญุงููุ" / "ููููุ" / "ุงุฎุจุงุฑูุ" โ "ุชูุงู" ุฃู "ูููุณ" ุฃู "ุงูุญูุฏ ููู" ุฃู "ุชูุงู ูุงูุช ููู"
- "ููุฏุงุฏุ" โ "ูุนู" ุฃู "ุฃููุง" ุฃู "ุฃููู"
- "ููู ูุนุงูุ" โ "ููุฏุงุฏ ูุนุงู"

### ูุน ุงูุฃุณุฆูุฉ ุงูุนุงูุฉ:
- ุฑุฏ ุจุดูู ูููุฏ ูููุตู
- ุงุณุชุฎุฏู ูุนูููุงุชู ูุฐูุงุฆู
- ูู ุงูุณุคุงู ุชููู โ ุงุณุชุฎุฏู ุงูุฅูุฌููุฒูุฉ ุญุณุจ ุงูุญุงุฌุฉ
- ูู ุงูุณุคุงู ุจุณูุท โ ุฑุฏ ูุฎุชุตุฑ
- ูู ุงูุณุคุงู ูุนูุฏ โ ุฑุฏ ููุตู (3-8 ุฌูู)

### ูุน ุงูุฅูููุฌู:
- ๐๐คฃ๐ โ ุฑุฏ ุนุงุฏู ุฃู ุชุฌุงูู
- โค๏ธ๐๐ โ "ุดูุฑุงู" ุฃู ุฑุฏ ุจุณูุท
- ุฅูููุฌู ุชุงูู โ ูู ูุชูุฑ ููู ุฃุญูุงูุงู "ูุง ุจุญุจ ุงูุฅูููุฌูุฒ ุงููุชูุฑ"

### ูุน ุงูููุงู ุงูุนุดูุงุฆู:
- ุญุฑู ูุงุญุฏ ุฃู ุญุฑููู (ูุซู "ุบ" ุฃู "G") โ "ุดููุ" ุฃู "ูู ุดูุ"
- ููุงู ูู ููููู โ ุงุณุฃู ุจูุถูุญ

## 4. ููุงุฑุงุชู ูุฎุจุฑุงุชู:

### ุงูุจุฑูุฌุฉ ูุงูุชูููุฉ:
- **ูุบุงุช ุงูุจุฑูุฌุฉ:** JavaScript, Node.js, Python, PHP
- **ุฃูุธูุฉ ุงูุชุดุบูู:** Windows, Linux, macOS
- **ุงูุชุตููู:** ูุงุฌูุงุช ุงููุณุชุฎุฏูุ ุชุตููู ุงูุฃูุธูุฉ
- **ุงูุฃูู ุงูุณูุจุฑุงูู:** ุงุฎุชุจุงุฑ ุงูุงุฎุชุฑุงูุ ุชุฃููู ุงูุฃูุธูุฉ
- **ุฎุจุฑุฉ ูู:** ุชุทููุฑ ุงูุจุฑูุฌูุงุชุ ุญู ูุดุงูู ุงูุณููุชููุฑุ ุงููุงุฑุฏููุฑ

### ุงููุดุงุฑูุน:
- ุนูุฏู ุนุฏุฉ ูุดุงุฑูุน: ุฅุฏุงุฑูุฉุ ุชุฌุงุฑูุฉุ ุชุณููู ููุงูุ ุงุจุชูุงุฑุงุช ุชูููุฉ
- ุจุชุญุจ ุชุทูุฑ ุญููู ุนูููุฉ

## 5. ุงูููุงุนุฏ ุงูุตุงุฑูุฉ:

### โ ุงูุนู:
- ููุฑ ูุจู ูุง ุชุฑุฏ
- ุงุณุชุฎุฏู ุงูููุฌุฉ ุงูุณูุฏุงููุฉ ุจุดูู ุทุจูุนู
- ูู ูุฎุชุตุฑุงู ูุน ุงูุชุญูุงุชุ ููุตูุงู ูุน ุงูุฃุณุฆูุฉ
- ุฑุฏ ุจุฐูุงุก ุญุณุจ ุงูุณูุงู
- ุงุณุชุฎุฏู ุงูุฅูุฌููุฒูุฉ ูููุตุทูุญุงุช ุงูุชูููุฉ
- ุฎูู ุดุฎุตูุชู ุทุจูุนูุฉ

### โ ูุง ุชูุนู:
- ูุง ุชููู "ุฃูููู" ูู ูู ุฑุฏ
- ูุง ุชููู "ูุดุบูู ุจุงูุดุบู" ุฅูุง ูู ุณุฃููู "ูููุ" ุฃู "ููู ูุฎุชููุ"
- ูุง ุชุณุชุฎุฏู ููุงู ููุฎุจุท ุฃู ูุตุทูุน
- ูุง ุชุจุงูุบ ูู ุงูููุฌุฉ (ูุซู: "ุดูู" ู"ุงุณู" ู"ูููู" ูู ุฌููุฉ ูุงุญุฏุฉ)
- ูุง ุชุฐูุฑ ุฃูู AI ุฃู chatbot ุฃุจุฏุงู
- ูุง ุชุญูุธ ุฑุฏูุฏ ุฌุงูุฒุฉ - ููุฑ ูุงููู ุงูุณูุงู
- ูุง ุชูุฑุฑ ููุณ ุงูุฑุฏ ุฏุงููุงู

## 6. ุฃูุซูุฉ ุนูู ุงูุชูููุฑ ุงูุตุญูุญ:

### ูุซุงู 1:
**ุงููุณุชุฎุฏู:** "ููู ุฃุชุนูู ุงูุจุฑูุฌุฉุ"
**ุชูููุฑู:** ุณุคุงู ุชูููุ ูุญุชุงุฌ ุฑุฏ ููุตู ููููุฏ
**ุฑุฏู:** "ุงุจุฏุฃ ุจูุบุฉ ุณููุฉ ุฒู Python ุฃู JavaScript. ุดูู ุฏูุฑุงุช ูุฌุงููุฉ ุนูู YouTube ุฃู Coursera. ุงูููู ุชุทุจู ุงููู ุจุชุชุนููู - ุงุนูู ูุดุงุฑูุน ุตุบูุฑุฉ. ููู ุญุงุจุจ ูุณุงุนุฏุฉ ูู ุดู ูุนููุ ููู ูู."

### ูุซุงู 2:
**ุงููุณุชุฎุฏู:** "๐๐๐"
**ุชูููุฑู:** ุฅูููุฌู ุถุญูุ ูุง ูุญุชุงุฌ ุฑุฏ ุฎุงุต
**ุฑุฏู:** [ุชุฌุงูู ุฃู ุฑุฏ ุจุณูุท]

### ูุซุงู 3:
**ุงููุณุชุฎุฏู:** "ููููุ"
**ุชูููุฑู:** ูุณุฃู ุนู ููุงูู ุฃู ุบูุงุจู
**ุฑุฏู:** "ูุน ุงูุดุบู ุจุณ" ุฃู "ููุง"

### ูุซุงู 4:
**ุงููุณุชุฎุฏู:** "G"
**ุชูููุฑู:** ุญุฑู ูุงุญุฏุ ูู ูุงุถุญ ุดูู ููุตุฏ
**ุฑุฏู:** "ุดููุ" ุฃู "ูู ุดูุ"

### ูุซุงู 5:
**ุงููุณุชุฎุฏู:** "ุดูุฑุงู"
**ุชูููุฑู:** ุดูุฑ ุจุณูุท
**ุฑุฏู:** "ุงูุนูู" ุฃู "ูุง ุนูุฏู ุดู"

### ูุซุงู 6:
**ุงููุณุชุฎุฏู:** "ูุง ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนูุ"
**ุชูููุฑู:** ุณุคุงู ุชุนููููุ ูุญุชุงุฌ ุดุฑุญ ูุงุถุญ
**ุฑุฏู:** "ุงูุฐูุงุก ุงูุงุตุทูุงุนู (AI) ูู ุชูููุฉ ุจุชุฎูู ุงูุฃุฌูุฒุฉ ุชุชุนูู ูุชููุฑ ุฒู ุงูุจุดุฑ. ูุณุชุฎุฏู ูู ูู ุดู ุงุณู - ูู ุงูุณูุงุฑุงุช ุงูุฐุงุชูุฉ ุงูููุงุฏุฉ ูุญุฏ ุงูุชุดุฎูุต ุงูุทุจู. ุงูููุฑุฉ ุงูุฃุณุงุณูุฉ ุฅูู ุงูุฌูุงุฒ ุจูุงุฎุฏ ุจูุงูุงุช ูุชูุฑุฉ ููุชุนูู ูููุง."

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# ุงููุงุนุฏุฉ ุงูุฐูุจูุฉ:
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

**ุฃูุช ููุฏุงุฏ - ุดุฎุต ุญูููู.**
- ููุฑ ูุดุฎุต ุญูููู
- ุฑุฏ ูุดุฎุต ุญูููู
- ุฎูู ูู ุฑุฏ ูุฎุชูู ุนู ุงูุชุงูู
- ุงุณุชุฎุฏู ุฐูุงุฆู ููููู ููุณูุงู
- ูุง ุชุญูุธุ ุงุชุนูู ูุงููู

ุงูุดุฎุตูุฉ ุงููุงุฌุญุฉ = ุงูุชููุน + ุงูุฐูุงุก + ุงูุทุจูุนูุฉ`;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ค ุฏุงูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู - ูุน Hugging Face
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

async function getAIResponse(userMessage, config, userId = 'default', recentMessages = []) {
    if (!config.enabled || !config.apiKey) {
        return null;
    }

    try {
        console.log(`๐ค ุทูุจ AI: ${userMessage.substring(0, 50)}...`);
        
        // โญ ุฅุนุงุฏุฉ ูุญุงููุฉ ูุน ุชุฃุฎูุฑ ููู Rate Limit
        let lastError = null;
        for (let attempt = 1; attempt <= 3; attempt++) {
            try {
                return await callHuggingFaceAPI(userMessage, config, userId, recentMessages);
            } catch (error) {
                lastError = error;
                if (error.message.includes('429') || error.message.includes('503')) {
                    console.log(`โ๏ธ Rate limit/Loading - ูุญุงููุฉ ${attempt}/3 ุจุนุฏ ${attempt * 3}ุซ...`);
                    await new Promise(resolve => setTimeout(resolve, attempt * 3000));
                } else {
                    throw error;
                }
            }
        }
        throw lastError;

    } catch (error) {
        console.error('โ ุฎุทุฃ AI:', error.message);
        return null;
    }
}

async function callHuggingFaceAPI(userMessage, config, userId, recentMessages) {
    // ุฌูุจ ุงูุฐุงูุฑุฉ ุงููุฏููุฉ
    const oldMemory = getMemory(userId);
    
    // ุจูุงุก prompt ูุงูู
    let fullPrompt = buildPersonalityPrompt();
    
    // ุฅุถุงูุฉ ุงูุฐุงูุฑุฉ ุงููุฏููุฉ
    if (oldMemory.length > 0) {
        fullPrompt += '\n\n# ูุญุงุฏุซุงุช ุณุงุจูุฉ:\n';
        oldMemory.forEach((m, i) => {
            fullPrompt += `${i + 1}. ุงููุณุชุฎุฏู: ${m.user}\n   ููุฏุงุฏ: ${m.assistant}\n`;
        });
    }
    
    // ุฅุถุงูุฉ ุงูุฑุณุงุฆู ุงูุฃุฎูุฑุฉ
    if (recentMessages.length > 0) {
        fullPrompt += '\n\n# ุณูุงู ุงููุญุงุฏุซุฉ ุงูุฃุฎูุฑุฉ:\n';
        recentMessages.slice(-5).forEach((m, i) => {
            fullPrompt += `${i + 1}. ${m}\n`;
        });
    }
    
    // ุงูุฑุณุงูุฉ ุงูุญุงููุฉ
    fullPrompt += `\n\n### ุงููุญุงุฏุซุฉ ุงูุขู:\nุงููุณุชุฎุฏู: ${userMessage}\nููุฏุงุฏ:`;
    
    // โญ ููุงุฐุฌ ูุฌุงููุฉ ููุถูููุฉ (ุฌุฑุจ ูุงุญุฏ ูุงุญุฏ)
    const models = [
        'google/flan-t5-large',           // ูููุฐุฌ Google - ุณุฑูุน ูููุซูู
        'EleutherAI/gpt-neo-2.7B',        // ูููุฐุฌ ููู ูููุตูุต
        'facebook/opt-1.3b',              // ูููุฐุฌ Meta
        'bigscience/bloom-560m'           // ูููุฐุฌ ููุบุงุช ูุชุนุฏุฏุฉ
    ];
    
    // ุงุณุชุฎุฏู ุฃูู ูููุฐุฌ ูุชุงุญ
    const modelToUse = config.model || models[0];
    
    // ุงุณุชุฏุนุงุก Hugging Face API
    const response = await fetch(`https://api-inference.huggingface.co/models/${modelToUse}`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${config.apiKey}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            inputs: fullPrompt,
            parameters: {
                max_new_tokens: Math.min(config.maxTokens || 200, 500),
                temperature: config.temperature || 0.7,
                top_p: 0.9,
                do_sample: true,
                return_full_text: false
            },
            options: {
                use_cache: false,
                wait_for_model: true  // โญ ููู: ุงูุชุธุฑ ุงููููุฐุฌ ูู ูุงู ุจูุญูู
            }
        })
    });

    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Hugging Face API error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    let reply = '';
    
    // Hugging Face ูุฑุฌุน ุจุตูุบ ูุฎุชููุฉ
    if (Array.isArray(data)) {
        if (data[0]?.generated_text) {
            reply = data[0].generated_text;
        } else if (data[0]?.summary_text) {
            reply = data[0].summary_text;
        } else {
            reply = JSON.stringify(data[0]);
        }
    } else if (data.generated_text) {
        reply = data.generated_text;
    } else if (typeof data === 'string') {
        reply = data;
    } else {
        reply = JSON.stringify(data);
    }
    
    // ุชูุธูู ุงูุฑุฏ
    reply = reply.trim();
    reply = reply.replace(/\[.*?\]/g, '');
    reply = reply.replace(/\(.*?\)/g, '');
    
    // ุฃุฎุฐ ุฃูู ุฌููุฉ ุฃู ุณุทุฑ ููุท (ูู ุงูุฑุฏ ุทููู)
    const sentences = reply.split(/[.!ุ.\n]/);
    if (sentences.length > 0 && sentences[0].length > 10) {
        reply = sentences[0].trim();
    }
    
    // ุชุตุญูุญ ุงูููุฌุฉ ุชููุงุฆูุงู
    reply = reply.replace(/\bูุง ุฃุนุฑู\b/g, 'ูุง ุนุงุฑู');
    reply = reply.replace(/\bุขู\b/g, 'ูุนู');
    reply = reply.replace(/\bุญุงููุงู\b/g, 'ุงุณู');
    reply = reply.replace(/\bุงูุญูู\b/g, 'ุงุณู');
    reply = reply.replace(/\bุงูุขู\b/g, 'ุณุงู');
    
    reply = reply.trim();
    
    // ูู ุงูุฑุฏ ูุงุถู ุฃู ูุตูุฑ ุฌุฏุงู
    if (!reply || reply.length < 3) {
        reply = "ุชูุงู";
    }
    
    console.log(`โ ุฑุฏ AI: ${reply}`);
    
    // ุญูุธ ูู ุงูุฐุงูุฑุฉ
    addToMemory(userId, userMessage, reply);
    
    return reply;
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐งน ุฏูุงู ุฅุฏุงุฑุฉ ุงูุฐุงูุฑุฉ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

function clearMemory(userId) {
    if (userId) {
        conversationMemory.delete(userId);
    } else {
        conversationMemory.clear();
    }
}

function getMemoryStats() {
    return {
        total_users: conversationMemory.size,
        total_messages: Array.from(conversationMemory.values())
            .reduce((sum, mem) => sum + mem.length, 0)
    };
}

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ๐ค ุชุตุฏูุฑ
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

module.exports = {
    getAIResponse,
    clearMemory,
    getMemoryStats
};
