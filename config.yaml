# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Upsun Configuration - WhatsApp Bot (Long-Running)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

applications:
  whatsapp-bot:
    source:
      root: /
    
    type: nodejs:20
    
    # â­ Web configuration - Ù…Ù‡Ù… Ù„Ù„Ù€ long-running process
    web:
      commands:
        # â­ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ´ØºÙ„ Ø§Ù„Ø¨ÙˆØª
        start: "node index.js"
      
      upstream:
        socket_family: tcp
        protocol: http
      
      locations:
        "/":
          root: ""
          passthru: true
          allow: false
      
      # â­ Ù…Ù‡Ù…: Ø®Ù„ÙŠ Ø§Ù„Ù€ process ÙŠØ´ØªØºÙ„ Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ ÙÙŠ requests
      move_to_cgroup: false
    
    # Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù…
    mounts:
      auth_info:
        source: storage
        source_path: auth_info
      logs:
        source: storage
        source_path: logs
    
    # Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù†Ø´Ø±
    hooks:
      build: |
        set -e
        echo "ğŸ“¦ Installing dependencies..."
        npm ci --only=production
        echo "âœ… Build complete!"
      
      deploy: |
        set -e
        echo "ğŸš€ Deploying WhatsApp Bot..."
        
        # â­ ÙØ­Øµ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        if [ -z "$SESSION_FILE" ]; then
          echo "âŒ SESSION_FILE not set!"
          exit 1
        fi
        
        if [ -z "$AI_API_KEY" ]; then
          echo "âš ï¸  AI_API_KEY not set - AI will be disabled"
        fi
        
        echo "âœ… Deployment successful!"
        echo "ğŸ“ Environment:"
        echo "   - NODE_ENV: $NODE_ENV"
        echo "   - PORT: $PORT"
        echo "   - SESSION_FILE: $SESSION_FILE"
    
    # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
    variables:
      env:
        NODE_ENV: production
        PORT: 8080

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Routes Configuration
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

routes:
  "https://{default}/":
    type: upstream
    upstream: "whatsapp-bot:http"
    cache:
      enabled: false
  
  "https://www.{default}/":
    type: redirect
    to: "https://{default}/"
